name: GSM Daily Report (Debug)

on:
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests matplotlib
      
      - name: Decode database file
        env:
          GSM_DB_BASE64: ${{ secrets.GSM_DB_BASE64 }}
        run: |
          echo "Decoding database..."
          echo "$GSM_DB_BASE64" | base64 -d > gsm.db
          echo "Database file created:"
          ls -lh gsm.db
          file gsm.db
      
      - name: Check database content
        run: |
          echo "=== Database Information ==="
          echo ""
          echo "Tables in database:"
          sqlite3 gsm.db "SELECT name FROM sqlite_master WHERE type='table'"
          echo ""
          echo "Total lines in database:"
          sqlite3 gsm.db "SELECT COUNT(*) FROM game_lines"
          echo ""
          echo "Latest 5 entries:"
          sqlite3 gsm.db "SELECT datetime(timestamp, 'unixepoch', 'localtime'), game_name, substr(line_text, 1, 30) FROM game_lines ORDER BY timestamp DESC LIMIT 5"
          echo ""
          echo "Lines from yesterday:"
          sqlite3 gsm.db "SELECT COUNT(*) FROM game_lines WHERE date(timestamp, 'unixepoch', 'localtime') = date('now', '-1 day')"
          echo ""
          echo "Lines from today:"
          sqlite3 gsm.db "SELECT COUNT(*) FROM game_lines WHERE date(timestamp, 'unixepoch', 'localtime') = date('now')"
          echo ""
          echo "Date range in database:"
          sqlite3 gsm.db "SELECT date(MIN(timestamp), 'unixepoch', 'localtime') as first_date, date(MAX(timestamp), 'unixepoch', 'localtime') as last_date FROM game_lines"
      
      - name: Check webhook URL
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "Webhook URL is set: ${DISCORD_WEBHOOK_URL:+YES}"
          echo "Webhook URL length: ${#DISCORD_WEBHOOK_URL}"
          echo "Webhook starts with: ${DISCORD_WEBHOOK_URL:0:35}..."
      
      - name: Test report generation
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "=== Running Report Generator ==="
          python gsm_reporter.py --force
```

5. **ã€ŒCommit new fileã€ã‚’ã‚¯ãƒªãƒƒã‚¯**

---

## â–¶ï¸ ãƒ‡ãƒãƒƒã‚°Workflowã‚’å®Ÿè¡Œ

1. **Actionsã‚¿ãƒ–ã‚’é–‹ã**

2. å·¦å´ã®ãƒªã‚¹ãƒˆã« **ã€ŒGSM Daily Report (Debug)ã€** ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚¯ãƒªãƒƒã‚¯

3. å³å´ã® **ã€ŒRun workflowã€** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

4. ã‚‚ã†ä¸€åº¦ **ã€ŒRun workflowã€** ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆç·‘ã®ãƒœã‚¿ãƒ³ï¼‰

5. **å®Ÿè¡ŒãŒå§‹ã¾ã‚Šã¾ã™**ï¼ˆ30ç§’ã€œ1åˆ†ã»ã©å¾…ã¤ï¼‰

---

## ğŸ“Š çµæœã‚’ç¢ºèª

1. **å®Ÿè¡Œä¸­ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯**

2. **ã€Œreportã€ã‚¸ãƒ§ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯**

3. **å„ã‚¹ãƒ†ãƒƒãƒ—ã‚’å±•é–‹**ã—ã¦å†…å®¹ã‚’ç¢ºèªï¼š

   ç‰¹ã«ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒé‡è¦ï¼š
   - **ã€ŒCheck database contentã€** - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä¸­èº«
   - **ã€ŒTest report generationã€** - ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆçµæœ

---

## ğŸ” ä½•ã‚’ç¢ºèªã™ã‚‹ã‹

### æ­£å¸¸ãªå ´åˆã®å‡ºåŠ›ä¾‹ï¼š
```
=== Database Information ===

Tables in database:
game_lines
ai_models
games

Total lines in database:
1543

Latest 5 entries:
2025-01-20 14:32:15|GameTitle|ã“ã‚Œã¯æ—¥æœ¬èªã®ãƒ†ã‚­ã‚¹ãƒˆã§ã™...
2025-01-20 14:31:42|GameTitle|ã‚‚ã£ã¨æ–‡ç« ãŒç¶šãã¾ã™...
...

Lines from yesterday:
87

Lines from today:
12

Date range in database:
2024-12-15|2025-01-20
```

### å•é¡ŒãŒã‚ã‚‹å ´åˆã®å‡ºåŠ›ä¾‹ï¼š
```
Total lines in database:
0

Lines from yesterday:
0
```

ã¾ãŸã¯
```
Error: no such table: game_lines
